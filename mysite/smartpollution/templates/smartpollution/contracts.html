<html>
<title>Devices</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
{% load static %}
<link rel="stylesheet" href="{% static 'smartpollution/w3.css' %}">
<link rel="stylesheet" href="{% static 'smartpollution/forms.css' %}">
<body>

<div class="w3-top">
    <div class="w3-bar w3-blue w3-card-2 w3-left-align w3-large">
        <a href="{% url 'smartpollution:index' %}"
           class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Devices</a>
        <a href="{% url 'smartpollution:index_templates' %}"
           class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Templates</a>
        <a href="{% url 'smartpollution:contract_monitor' %}"
           class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Contract monitor</a>

        <a href="{% url 'smartpollution:about' %}"
           class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">About</a>
    </div>
</div>
<!-- Header -->
<header class="w3-container w3-blue w3-center" style="padding:128px 16px">
    <h1 class="w3-margin w3-jumbo">Contract monitor</h1>
    <a href="{% url 'smartpollution:register_contract' %}" button
       class="w3-button w3-black w3-padding-large w3-large w3-margin-top">Register a new contract to be watched</a>
</header>

<div class="w3-row-padding w3-padding-64 w3-container">
    <div class="w3-content">
        <br class="w3-twothird">
        <h1>Active contracts:</h1>
        {% for contract in contracts %}
            <ul class="w3-ul">
                Watch this contract on Etherscan.io: <a id=link{{ contract.id }}
                                                        href='https://google.com'>{{ contract.contract_name }}</a>
                <li>Contract address: {{ contract.contract_address }}</li>
                <li id={{ contract.id }}>Current Value</li>
                <script src='../../static/smartpollution/web3.min.js'></script>
                <script src="../../static/smartpollution/jquery-3.1.1.min.js"></script>
                <script>
                    var Web3 = require('web3');
                    var web3 = new Web3(new Web3.providers.HttpProvider('https://ropsten.infura.io/6I3dntS0W3179HBtMu0X'));
                    var version = web3.version.api;

                    var abi = '[ { "constant": false, "inputs": [ { "name": "_value", "type": "int32" } ], "name": "changeLowerTrigger", "outputs": [], "payable": false, "type": "function" }, { "constant": true, "inputs": [], "name": "metric", "outputs": [ { "name": "name", "type": "string", "value": "place_holder_metric_name_to_be_autogenerated" }, { "name": "value", "type": "int32", "value": "666" } ], "payable": false, "type": "function" }, { "constant": false, "inputs": [ { "name": "_value", "type": "int32" } ], "name": "changeUpperTrigger", "outputs": [], "payable": false, "type": "function" }, { "constant": false, "inputs": [ { "name": "_value", "type": "int32" } ], "name": "update", "outputs": [], "payable": false, "type": "function" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "_value", "type": "int32" } ], "name": "ValueChanged", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "_alarm", "type": "string" }, { "indexed": false, "name": "_value", "type": "int32" } ], "name": "Alarm", "type": "event" } ]';
                    var abi = JSON.parse(abi);

                    var contAbi = web3.eth.contract(abi);
                    var cont = contAbi.at('{{ contract.contract_address }}');
                    //var events = cont.allEvents({fromBlock: 500000, toBlock: 'latest'});
                    //var temp_str='';
                    //events.get(function(error, result){ temp_str=JSON.stringify(result);});
                    document.getElementById('link'+String({{ contract.id }})).href = "https://ropsten.etherscan.io/address/"+String('{{ contract.contract_address }}');
                    document.getElementById({{ contract.id }}).innerHTML = cont.metric();
                </script>
            </ul>
            <br>
        {% endfor %}

        </ul>
    </div>
    <div class="w3-third w3-center">
    </div>

</div>
</div>
</body>